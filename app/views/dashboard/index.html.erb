<% content_for :header_info do %>
  <div id="kcal-limit">
    Limite diário de calorias:<br />
    <% if current_user.kcal_limit.nil? %>
      <span id="kcal-limit-value"><%= link_to "0 Kcal", '#', :id => 'kcal-limit-link' %></span>
      <span id="change-kcal-label">definir</span>
    <% else %>
      <span id="kcal-limit-value"><%= link_to "#{current_user.kcal_limit} Kcal", '#', :id => 'kcal-limit-link' %></span>
      <span id="change-kcal-label">alterar</span>
    <% end -%>
    
    <%= form_tag(kcal_limit_path, :remote => true, :method => :put, :id => 'kcal-limit-form', :style => 'display: none') do |f| %>
      <%= text_field_tag :kcal_limit, current_user.kcal_limit %>
      <%= submit_tag "Atualizar" %> 
    <% end -%>
  </div>
<% end %>


<%= javascript_tag %{
  $('#kcal-limit-link').click(function() {
    $('#kcal-limit-value').hide();
    $('#change-kcal-label').hide();
    $('#kcal-limit-form').show();
    $('#kcal_limit').focus();
    $('#kcal_limit').select();
  });
} %>

<div id="kcal-measure">
  <div class="title">Total: <strong><span id="total-kcal"><%= number_with_precision(@total_kcal, :precision => 0) %></span> Kcal</strong></div>
  <div id="progress">
    <% if @total_kcal.zero? %>
      <div class="progressbar"><span>Não contabilizado</span></div>
    <% else %>
      <% if !@percent_kcal_kind_a.zero? %>
        <div id="nice" class="progressbar" style="width: <%= number_with_precision(@percent_kcal_kind_a, :precision => 0) %>%"><span><%= number_with_precision(@percent_kcal_kind_a, :precision => 0) %>%</span></div>
      <% end %>
      <% if !@percent_kcal_kind_b.zero? %>
        <div id="fair" class="progressbar" style="width: <%= number_with_precision(@percent_kcal_kind_b, :precision => 0) %>%"><span><%= number_with_precision(@percent_kcal_kind_b, :precision => 0) %>%</span></div>
      <% end %>
      <% if !@percent_kcal_kind_c.zero? %>
        <div id="poor" class="progressbar" style="width: <%= number_with_precision(@percent_kcal_kind_c, :precision => 0) %>%"><span><%= number_with_precision(@percent_kcal_kind_c, :precision => 0) %>%</span></div>
      <% end %>
    <% end -%>
  </div>
</div>

<!--div id="weight-info">
  <div class="title">Seu peso:</div>
  <div id="weight">89kg</div>
</div-->

<nav>
  <div id="prev-date"><%= link_to 'anterior', dashboard_path(:year => @previous_day.year, :month => "%02d" % @previous_day.month, :day => "%02d" % @previous_day.day) %></div>
  <div id="current-date"><%=l @date %></div>
  <div id="next-date"><%= link_to 'próximo', dashboard_path(:year => @next_day.year, :month => "%02d" % @next_day.month, :day => "%02d" % @next_day.day) %></div>
</nav>


<br/><br/><br/><br/><br/><br/><br/>


<h2>Total do dia: <span id="total-kcal"><%= number_with_precision(@total_kcal, :precision => 0) %></span> Kcal</h2>
<br/><br/><br/>

<%= form_tag do -%>

<% [:breakfast, :brunch, :lunch, :tea, :dinner, :supper].each do |meal| %>
  <h1><%=t ".#{meal}" %> - <span id="total-kcal-<%= meal %>"><%= number_with_precision(current_user.consumed_kcal(:date => @date, :meal => meal), :precision => 0) %></span> Kcal</h1>
  <%= autocomplete_field :food_name, '', autocomplete_food_name_path, :class => "food_name_autocomplete", :"data-meal" => meal -%>

  <ul id="foods-<%= meal %>">
    <%= render current_user.consumed_foods(:date => @date, :meal => meal), :as => 'user_food' %>
  </ul>
<% end -%>

<%- end -%>

<%= javascript_tag %{
  $('.food_name_autocomplete').bind('railsAutocomplete.select', function(event, data){
    $.ajax({
      type: 'POST',
      url: "#{user_foods_url}",
      dataType: "script",
      data: {
        user_food: {
          date: '#{Date.today.to_s(:db)}',
          food_id: data.item.id,
          meal: $(this).attr('data-meal')
        }
      }
    });
    $(this).val('');
  });
} %>
